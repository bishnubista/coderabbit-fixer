#!/usr/bin/env bash
#
# cr-metrics - Track and compare CodeRabbit fixer run metrics
#
# Usage:
#   cr-metrics end [--builds N] [--commits N] [--rounds N]
#   cr-metrics show [--pr N] [--last N]
#   cr-metrics reset
#
set -euo pipefail

METRICS_FILE="${HOME}/.coderabbit-metrics.jsonl"
STATE_FILE=".coderabbit-review.json"
RED='\033[0;31m'; GREEN='\033[0;32m'; YELLOW='\033[1;33m'; CYAN='\033[0;36m'; DIM='\033[2m'; NC='\033[0m'

die() { echo -e "${RED}ERROR: $1${NC}" >&2; exit 1; }

# ── Subcommand: end ───────────────────────────────────────────────────────
cmd_end() {
  local BUILDS=0 COMMITS=0 ROUNDS=0

  while [[ $# -gt 0 ]]; do
    case $1 in
      --builds) BUILDS="$2"; shift 2 ;;
      --commits) COMMITS="$2"; shift 2 ;;
      --rounds) ROUNDS="$2"; shift 2 ;;
      *) shift ;;
    esac
  done

  [[ -f "$STATE_FILE" ]] || die "State file not found. Run cr-gather first."

  local REPO PR STARTED_AT ENDED_AT DURATION_S
  REPO=$(jq -r '.repository' "$STATE_FILE")
  PR=$(jq -r '.pr_number' "$STATE_FILE")
  STARTED_AT=$(jq -r '.metrics.started_at // .gathered_at' "$STATE_FILE")
  ENDED_AT=$(date -u +%Y-%m-%dT%H:%M:%SZ)

  # Compute duration in seconds
  if [[ "$(uname)" == "Darwin" ]]; then
    local START_EPOCH END_EPOCH
    START_EPOCH=$(date -jf "%Y-%m-%dT%H:%M:%SZ" "$STARTED_AT" +%s 2>/dev/null || date +%s)
    END_EPOCH=$(date -jf "%Y-%m-%dT%H:%M:%SZ" "$ENDED_AT" +%s)
    DURATION_S=$((END_EPOCH - START_EPOCH))
  else
    local START_EPOCH END_EPOCH
    START_EPOCH=$(date -d "$STARTED_AT" +%s 2>/dev/null || date +%s)
    END_EPOCH=$(date -d "$ENDED_AT" +%s)
    DURATION_S=$((END_EPOCH - START_EPOCH))
  fi

  # Read issue counts from state file
  local TOTAL CRITICAL MAJOR MINOR NITPICK FIXED
  TOTAL=$(jq '.summary.total // 0' "$STATE_FILE")
  CRITICAL=$(jq '.summary.critical // 0' "$STATE_FILE")
  MAJOR=$(jq '.summary.major // 0' "$STATE_FILE")
  MINOR=$(jq '.summary.minor // 0' "$STATE_FILE")
  NITPICK=$(jq '.summary.nitpick // 0' "$STATE_FILE")
  FIXED=$(jq '.summary.fixed // 0' "$STATE_FILE")

  # Build JSONL entry
  local ENTRY
  ENTRY=$(jq -n \
    --argjson pr "$PR" \
    --arg repo "$REPO" \
    --arg started_at "$STARTED_AT" \
    --arg ended_at "$ENDED_AT" \
    --argjson duration_s "$DURATION_S" \
    --argjson total "$TOTAL" \
    --argjson critical "$CRITICAL" \
    --argjson major "$MAJOR" \
    --argjson minor "$MINOR" \
    --argjson nitpick "$NITPICK" \
    --argjson fixed "$FIXED" \
    --argjson builds "$BUILDS" \
    --argjson commits "$COMMITS" \
    --argjson rounds "$ROUNDS" \
    '{pr: $pr, repo: $repo, started_at: $started_at, ended_at: $ended_at, duration_s: $duration_s, issues: {total: $total, critical: $critical, major: $major, minor: $minor, nitpick: $nitpick}, fixed: $fixed, builds: $builds, commits: $commits, rounds: $rounds}' \
    | jq -c .)

  echo "$ENTRY" >> "$METRICS_FILE"

  # Format duration for display
  local MINS SECS
  MINS=$((DURATION_S / 60))
  SECS=$((DURATION_S % 60))

  echo -e "${GREEN}Run logged:${NC} ${FIXED}/${TOTAL} fixed in ${MINS}m ${SECS}s (${BUILDS} build(s), ${COMMITS} commit(s), ${ROUNDS} round(s))"
  echo -e "${DIM}  Saved to: ${METRICS_FILE}${NC}"
}

# ── Subcommand: show ──────────────────────────────────────────────────────
cmd_show() {
  local FILTER_PR="" LAST=10

  while [[ $# -gt 0 ]]; do
    case $1 in
      --pr) FILTER_PR="$2"; shift 2 ;;
      --last) LAST="$2"; shift 2 ;;
      *) shift ;;
    esac
  done

  if [[ ! -f "$METRICS_FILE" ]]; then
    echo -e "${YELLOW}No metrics recorded yet.${NC} Runs are logged after /fix-coderabbit completes."
    exit 0
  fi

  # Build jq filter
  local JQ_FILTER="."
  if [[ -n "$FILTER_PR" ]]; then
    JQ_FILTER="select(.pr == $FILTER_PR)"
  fi

  # Read entries, filter, take last N
  local ENTRIES
  ENTRIES=$(jq -s "[.[] | $JQ_FILTER] | .[-${LAST}:]" "$METRICS_FILE")
  local COUNT
  COUNT=$(echo "$ENTRIES" | jq 'length')

  if [[ "$COUNT" -eq 0 ]]; then
    if [[ -n "$FILTER_PR" ]]; then
      echo -e "${YELLOW}No metrics for PR #${FILTER_PR}.${NC}"
    else
      echo -e "${YELLOW}No metrics recorded yet.${NC}"
    fi
    exit 0
  fi

  # Header
  if [[ -n "$FILTER_PR" ]]; then
    local REPO
    REPO=$(echo "$ENTRIES" | jq -r '.[0].repo')
    echo -e "${CYAN}CodeRabbit Fixer Metrics — ${REPO}#${FILTER_PR}${NC}"
  else
    echo -e "${CYAN}CodeRabbit Fixer Metrics — Last ${COUNT} run(s)${NC}"
  fi
  echo ""

  # Table header
  printf "%-6s %-25s %8s %8s %8s %8s %8s\n" "PR" "Started" "Fixed" "Total" "Time" "Builds" "Rounds"
  printf "%-6s %-25s %8s %8s %8s %8s %8s\n" "──────" "─────────────────────────" "────────" "────────" "────────" "────────" "────────"

  # Table rows
  echo "$ENTRIES" | jq -r '.[] |
    (.duration_s | . as $d | (($d / 60) | floor | tostring) + "m " + (($d % 60) | tostring) + "s") as $time |
    [
      ("#" + (.pr | tostring)),
      (.started_at | .[0:19] | gsub("T"; " ")),
      ((.fixed | tostring) + "/" + (.issues.total | tostring)),
      (.issues | "\(.critical)c \(.major)M \(.minor)m"),
      $time,
      (.builds | tostring),
      (.rounds | tostring)
    ] | @tsv
  ' | while IFS=$'\t' read -r pr started fixed breakdown time builds rounds; do
    printf "%-6s %-25s %8s %8s %8s %8s %8s\n" "$pr" "$started" "$fixed" "$breakdown" "$time" "$builds" "$rounds"
  done

  echo ""

  # Trend calculation if multiple entries for same PR
  if [[ "$COUNT" -ge 2 ]]; then
    local FIRST_DURATION LAST_DURATION
    FIRST_DURATION=$(echo "$ENTRIES" | jq '.[0].duration_s')
    LAST_DURATION=$(echo "$ENTRIES" | jq '.[-1].duration_s')

    if [[ "$FIRST_DURATION" -gt 0 ]]; then
      local DIFF=$((LAST_DURATION - FIRST_DURATION))
      local FIRST_MINS=$((FIRST_DURATION / 60))
      local LAST_MINS=$((LAST_DURATION / 60))

      if [[ "$DIFF" -lt 0 ]]; then
        local ABS_DIFF=$(( -DIFF ))
        local SAVED_MINS=$((ABS_DIFF / 60))
        local SAVED_SECS=$((ABS_DIFF % 60))
        echo -e "${GREEN}Trend: ${SAVED_MINS}m ${SAVED_SECS}s faster than first run${NC}"
      elif [[ "$DIFF" -gt 0 ]]; then
        local ADDED_MINS=$((DIFF / 60))
        local ADDED_SECS=$((DIFF % 60))
        echo -e "${YELLOW}Trend: ${ADDED_MINS}m ${ADDED_SECS}s slower than first run${NC} (likely more issues)"
      else
        echo -e "Trend: Same duration as first run"
      fi
    fi
  fi
}

# ── Subcommand: reset ─────────────────────────────────────────────────────
cmd_reset() {
  if [[ -f "$METRICS_FILE" ]]; then
    local COUNT
    COUNT=$(wc -l < "$METRICS_FILE" | tr -d ' ')
    rm -f "$METRICS_FILE"
    echo -e "${GREEN}Deleted ${METRICS_FILE}${NC} (${COUNT} entries)"
  else
    echo "No metrics file found. Nothing to reset."
  fi
}

# ── Main ──────────────────────────────────────────────────────────────────
if [[ $# -eq 0 ]]; then
  head -9 "$0" | tail -6
  exit 0
fi

SUBCMD="$1"; shift
case "$SUBCMD" in
  end)   cmd_end "$@" ;;
  show)  cmd_show "$@" ;;
  reset) cmd_reset "$@" ;;
  --help|-h) head -9 "$0" | tail -6 ;;
  *) die "Unknown command: $SUBCMD. Use: end | show | reset" ;;
esac
